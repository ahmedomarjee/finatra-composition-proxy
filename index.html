<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Finatra Composition-Proxy : Easily compose microservices into a rich REST API">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Finatra Composition-Proxy</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mosche/finatra-composition-proxy">View on GitHub</a>

          <h1 id="project_title">Finatra Composition-Proxy</h1>
          <h2 id="project_tagline">Easily compose microservices into a rich REST API</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mosche/finatra-composition-proxy/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mosche/finatra-composition-proxy/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p><a href="http://finatra.info/"><em>Finatra</em></a> is a <em>Scala</em> web framework inspired by <em>Sinatra</em> and build on top of <em>Twitter-Server</em>.
As such it provides rich metrics, templating and integrates well with <a href="https://twitter.github.io/finagle/"><em>Finagle</em></a>, Twitter's protocol-agnostic async RPC system.
<a href="http://monkey.org/%7Emarius/funsrv.pdf"><em>Your Server as a Function</em></a>, a great paper by Marius Eriksen, describes the philosophy behind <em>Finagle</em> and how <em>Futures</em>, <em>Services</em> and <em>Filters</em> play so well together.</p>

<h2>
<a id="microservice-composition" class="anchor" href="#microservice-composition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Microservice composition</h2>

<p>The past two years I've seen lots of companies starting to adapt the <a href="http://martinfowler.com/articles/microservices.html"><em>microservice</em></a> paradigm.
Among the various challenges, there's a lot of discussions around the <em>composition challenge</em>, regardless whether services shall be composed in a large website or into a single REST API.</p>

<p>Talking about a single REST endpoint, the goal certainly shouldn't be to transform one monolith into another (your proxy) and build lots of beautiful manageable <em>microservice</em> around it.
But dealing with various devices, particularly talking about mobile, there certainly is an advantage in aggregating the various calls to a multitude of services into some few ones.</p>

<p>Already some while ago Twitter presented <a href="https://www.youtube.com/watch?v=VVpmMfT8aYw"><em>Stitch</em></a>, a library for composing <em>Finagle</em> services.
<em>Stitch</em> provides a concise Scala query API which facilitates a readable expression of application logic hiding the complexity of bulk RPC calls.
That way <em>Stitch</em> efficiently allows Twitter to build Services on top of other Services. But, unfortunately, <em>Stitch</em> is not open-sourced yet.</p>

<p><a href="http://getclump.io/"><em>Clump</em></a>, which is deeply inspired by <em>Stitch</em>, was just recently open-sourced by developers from SoundCloud.
Similarly to <em>Stitch</em> it provides an easy to use declarative approach focusing on <em>what</em> to fetch instead of <em>how</em> to fetch it.
Performance is then enhanced by means of bulk requests, parallel requests to multiple sources and an underlying caching layer.</p>

<h2>
<a id="the-composition-proxy" class="anchor" href="#the-composition-proxy" aria-hidden="true"><span class="octicon octicon-link"></span></a>The composition proxy</h2>

<p>The composition proxy attempts to take the declarative approach of <em>Stitch</em> and <em>Clump</em> one step further.
Following a configuration based approach defining <em>what</em> can be fetched, the <em>how</em> is totally left open.
Instead, based on a configuration, an entire REST API with some nifty features is automatically generated.</p>

<h4>
<a id="example-controller-by-configuration" class="anchor" href="#example-controller-by-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example: Controller by configuration</h4>

<div class="highlight highlight-scala"><pre>  <span class="pl-c">// GET /shop/products/:id</span>
  <span class="pl-c">// GET /shop/products/:id/reviews</span>
  <span class="pl-c">// GET /shop/reviews/:id</span>
  <span class="pl-c">// GET /shop/reviews/:id/comments</span>

  <span class="pl-s">lazy</span> <span class="pl-k">val</span> <span class="pl-en">shopController</span><span class="pl-k">:</span> <span class="pl-en">Controller</span> <span class="pl-k">=</span> <span class="pl-en">CompositionControllerBuilder</span>()
    .register[<span class="pl-en">Product</span>](<span class="pl-s1"><span class="pl-pds">"</span>products<span class="pl-pds">"</span></span>)
    .as(productIdExtractor, productService.getProducts)
    .having(
      <span class="pl-s1"><span class="pl-pds">"</span>categories<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToOne</span>(categoryIdExtractor, productService.getCategories, <span class="pl-en">Array</span>),
      <span class="pl-s1"><span class="pl-pds">"</span>reviews<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToMany</span>(productIdExtractor, reviewService.getReviewsByProduct)
    )
    .register[<span class="pl-en">Review</span>](<span class="pl-s1"><span class="pl-pds">"</span>reviews<span class="pl-pds">"</span></span>)
    .as(reviewIdExtractor, reviewService.getReviews)
    .having(
      <span class="pl-s1"><span class="pl-pds">"</span>reviewer<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToOne</span>(userIdExtractor, userService.getUsers),
      <span class="pl-s1"><span class="pl-pds">"</span>product<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToOne</span>(productIdExtractor, productService.getProducts),
      <span class="pl-s1"><span class="pl-pds">"</span>categories<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToMany</span>(productIdExtractor, productService.getCategoriesByProduct),
      <span class="pl-s1"><span class="pl-pds">"</span>comments<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-en">ToMany</span>(reviewIdExtractor, commentService.getCommentsByReview)
    )
    .buildController(<span class="pl-s1"><span class="pl-pds">"</span>/shop<span class="pl-pds">"</span></span>)</pre></div>

<p><em>Fields</em> and <em>relations</em> (by means of a RPC call) are returned on demand by means of a concise query DSL (<a href="#the-properties-dsl">the <em>properties</em> DSL</a>) in order to address the specific information need as well as limitations of an API client. Leveraging the query DSL code complexity is significantly reduced both on client as well as the server side.</p>

<h3>
<a id="query-optimization" class="anchor" href="#query-optimization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query optimization</h3>

<p>Queries are translated into an optimized <a href="#the-execution-plan"><em>execution plan</em></a> in order to enhance performance as much as possible. Optimizations taken into account are:</p>

<ul>
<li>
<p>rearrangement of <em>relations</em> in order to maximize parallelism <a href="#the-execution-plan">[more]</a></p>

<p><strong>Example</strong>: Even though <em>comments</em> is defined as a relation of <em>reviews</em>, both can be fetched in parallel as they are using the same <em>Id extractor</em>.</p>
</li>
<li>
<p>bulk requests accross multiple composition levels <a href="#the-execution-plan">[more]</a></p>

<p><strong>Example</strong>: Assuming there is a relation <em>creator</em> of <em>comments</em>, both the <em>reviewers</em> of <em>reviews</em> as well as the <em>creators</em> of <em>comments</em> can be fetched using one bulk request.</p>
</li>
<li>
<p>a caching layer on the request level</p>

<p><strong>Example</strong>: In some cases execution will require fetching data immediately to resolve further nested relations. To address such cases data is cached to avoid fetching the same data once again. </p>
</li>
</ul>

<h3>
<a id="the-properties-dsl" class="anchor" href="#the-properties-dsl" aria-hidden="true"><span class="octicon octicon-link"></span></a>The properties DSL</h3>

<p>Similar to Facebook's <a href="https://developers.facebook.com/docs/graph-api/using-graph-api/#fieldexpansion"><em>field expansion (Graph API)</em></a>, <em>fields</em> and <em>relations</em> are requested on demand.</p>

<p>Properties are queried according to the following grammar:</p>

<pre><code>  field -&gt; AlphaNumericIdentifier
  relation -&gt; field '(' properties ')' 
  property -&gt; field | relation
  properties -&gt; ( property ',' ) property
</code></pre>

<p><em>Properties</em> are then appended to the request as a query parameter <em>properties</em>, e.g. <code>?properties=id,title,reviews(stars)</code></p>

<h3>
<a id="the-execution-plan" class="anchor" href="#the-execution-plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>The execution plan</h3>

<p>Based on a properties tree an optimized <em>execution plan</em> is generated according to the following optimizations:</p>

<ol>
<li><p>Whenever nested relations in the tree are using the same <em>Id extractor</em> as their parent relation,
such relations are moved upwards in the graph to increase parallelism during execution.
Therefore relations must be invariant on the id. That will say applying the <em>Id extractor</em> on the relation result(s) will produce the same Id again.
If this is not the case for a particular relation it must be marked with the execution hint <em>NonBijective</em>.</p></li>
<li><p>Once subtrees are sorted according to their depth, execution can later be split into two phases:
From the flattest to the deepest subtree all available Ids for a <em>relation source</em> are collected first - even accross multiple levels in the tree.
Afterwards, depth first from the deepest to the flattest subtree (again respecting the two phases for following subtrees),
the <em>batch source executor</em> will load the data for all collected Ids.
As relations trees tend to be highly unbalanced this simple execution strategy works really well.</p></li>
</ol>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Just a tiny example illustrating the idea of JSON composition to build up a powerful REST API backed by a <em>microservice</em> architecture.</p>

<p>There's actually no remote services used in this example. However, some fake services shall demonstrate the case.</p>

<h3>
<a id="run-the-example" class="anchor" href="#run-the-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run the example</h3>

<p><code>sbt example/run</code></p>

<h5>
<a id="example-1-load-a-product-with-id-and-title-only" class="anchor" href="#example-1-load-a-product-with-id-and-title-only" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 1: Load a product with id and title only<br>
</h5>

<pre><code>curl http://localhost:7070/shop/products/1?properties=id,title
</code></pre>

<div class="highlight highlight-javascript"><pre>{
 id<span class="pl-k">:</span> <span class="pl-c1">1</span>,
 title<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>Apple iBook<span class="pl-pds">"</span></span>
}</pre></div>

<h5>
<a id="example-2-load-a-product-with-all-its-categories-reviews-and-the-reviewer" class="anchor" href="#example-2-load-a-product-with-all-its-categories-reviews-and-the-reviewer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 2: Load a product with all its categories, reviews and the reviewer<br>
</h5>

<pre><code>curl http://localhost:7070/shop/products/1?properties=id,title,reviews(stars,review,reviewer(username)),categories(id)
</code></pre>

<div class="highlight highlight-javascript"><pre>{
 id<span class="pl-k">:</span> <span class="pl-c1">1</span>,
 title<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>Apple iBook<span class="pl-pds">"</span></span>,
 categories<span class="pl-k">:</span> [
   {
     id<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>computer<span class="pl-pds">"</span></span>
   },
   {
     id<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>laptop<span class="pl-pds">"</span></span>
   }
 ],
 reviews<span class="pl-k">:</span> [
   {
     stars<span class="pl-k">:</span> <span class="pl-c1">4</span>,
     review<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>looks nice<span class="pl-pds">"</span></span>,
     reviewer<span class="pl-k">:</span> {
       username<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>steff<span class="pl-pds">"</span></span>
     }
   },
   {
     stars<span class="pl-k">:</span> <span class="pl-c1">3</span>,
     review<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>expensive<span class="pl-pds">"</span></span>,
     reviewer<span class="pl-k">:</span> {
       username<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>mark<span class="pl-pds">"</span></span>
     }
   },
   {
     stars<span class="pl-k">:</span> <span class="pl-c1">5</span>,
     review<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>awesome, always again<span class="pl-pds">"</span></span>,
     reviewer<span class="pl-k">:</span> {
       username<span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>chris<span class="pl-pds">"</span></span>
     }
   }
 ]
}</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Finatra Composition-Proxy maintained by <a href="https://github.com/mosche">mosche</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
